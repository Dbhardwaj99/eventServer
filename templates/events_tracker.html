<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Events Tracker</title>
  <style>
    :root { --bg:#0e1117; --card:#111827; --card-alt:#0f1623; --border:#1f2937; --title:#e5e7eb; --text:#d1d5db; --muted:#9ca3af; --badge:#1f2937; --accent:#22c55e; --dot:#22c55e; --shadow:rgba(0,0,0,0.3); --key:#7dd3fc; --string:#a7f3d0; --number:#fca5a5; --bool:#fde68a; --null:#c4b5fd; }
    body.light { --bg:#f7f7f5; --card:#ffffff; --card-alt:#f8fafc; --border:#e5e7eb; --title:#0f172a; --text:#1f2937; --muted:#6b7280; --badge:#eef2f7; --accent:#16a34a; --dot:#16a34a; --shadow:rgba(0,0,0,0.06); --key:#0369a1; --string:#047857; --number:#b91c1c; --bool:#a16207; --null:#6d28d9; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    header { position: sticky; top: 0; background: color-mix(in oklab, var(--bg) 92%, transparent); padding: 12px 16px; border-bottom: 1px solid var(--border); backdrop-filter: blur(10px); z-index: 10; }
    header .row { display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .status { font-size: 12px; color: var(--muted); }
    .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .left { display: flex; gap: 10px; align-items: center; }
    .nav { display: flex; gap: 8px; }
    .btn, select, input[type="text"] { background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 6px 10px; font-size: 13px; line-height: 1.2; box-shadow: 0 1px 0 var(--shadow); }
    .btn { cursor: pointer; }
    .pane-wrap { display: grid; gap: 12px; padding: 16px; grid-template-columns: repeat(3, 1fr); }
    .pane { background: var(--card); border: 1px solid var(--border); border-radius: 12px; display: flex; flex-direction: column; min-height: 60vh; box-shadow: 0 2px 0 var(--shadow); }
    .pane-header { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 10px; border-bottom: 1px solid var(--border); }
    .pane-title { font-weight: 700; color: var(--title); font-size: 14px; }
    .count { font-size: 12px; color: var(--muted); }
    .input { width: 100%; }
    .stream { padding: 10px; display: grid; gap: 10px; overflow: auto; }
    .event-card { background: var(--card-alt); border: 1px solid var(--border); border-radius: 10px; padding: 12px; }
    @keyframes flashNew { from { box-shadow: 0 0 0 9999px rgba(34,197,94,0.14) inset; } to { box-shadow: 0 0 0 9999px rgba(34,197,94,0) inset; } }
    .flash-new { animation: flashNew 1100ms ease-out 1; }
    .event-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
    .head-right { display: flex; align-items: center; gap: 8px; }
    .badge { font-size: 11px; padding: 2px 8px; border-radius: 999px; background: var(--badge); color: var(--text); border: 1px solid var(--border); }
    .badge.dot { width: 8px; height: 8px; padding: 0; border-radius: 999px; background: var(--dot); border: 1px solid color-mix(in oklab, var(--dot) 40%, black); box-shadow: 0 0 0 3px color-mix(in oklab, var(--dot) 20%, transparent); }
    pre { margin: 0; white-space: pre-wrap; word-wrap: break-word; overflow: auto; font-size: 12px; line-height: 1.5; }
    .j-key { color: var(--key); } .j-string { color: var(--string); } .j-number { color: var(--number); } .j-bool { color: var(--bool); } .j-null { color: var(--null); }
    @media (max-width: 1100px) { .pane-wrap { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  {% include "_navbar.html" %}
  <header style="display:none"></header>
  <section style="padding:12px 16px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
    <div id="status" class="status">Idle</div>
    <label for="interval">Refresh</label>
    <select id="interval">
      <option value="1000">1s</option>
      <option value="2000">2s</option>
      <option value="3000" selected>3s</option>
      <option value="5000">5s</option>
      <option value="10000">10s</option>
      <option value="0">Pause</option>
    </select>
  </section>

  <section class="pane-wrap">
    <div class="pane" data-slot="0">
      <div class="pane-header">
        <input class="btn input" type="text" placeholder="Track eventName #1" />
        <span class="count" data-count>0</span>
      </div>
      <div class="stream" data-stream></div>
    </div>
    <div class="pane" data-slot="1">
      <div class="pane-header">
        <input class="btn input" type="text" placeholder="Track eventName #2" />
        <span class="count" data-count>0</span>
      </div>
      <div class="stream" data-stream></div>
    </div>
    <div class="pane" data-slot="2">
      <div class="pane-header">
        <input class="btn input" type="text" placeholder="Track eventName #3" />
        <span class="count" data-count>0</span>
      </div>
      <div class="stream" data-stream></div>
    </div>
  </section>

  <script>
    // Theme handled globally by navbar include

    const FETCH_URL = '/events-feed';
    const statusEl = document.getElementById('status');
    const intervalSel = document.getElementById('interval');

    const panes = Array.from(document.querySelectorAll('.pane')).map(p => ({
      input: p.querySelector('input'),
      stream: p.querySelector('[data-stream]'),
      countEl: p.querySelector('[data-count]'),
      name: '',
      count: 0,
    }));

    function tryParseJSONMaybeString(str) {
      if (typeof str !== 'string') return str;
      try { return JSON.parse(str); } catch (_) { return str; }
    }
    function syntaxHighlight(obj) {
      const json = JSON.stringify(obj, null, 2);
      return json
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/("(\\u[a-fA-F0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d+)?(?:[eE][+\-]?\d+)?)/g, match => {
          let cls = 'j-number';
          if (/^"/.test(match)) {
            cls = /:$/.test(match) ? 'j-key' : 'j-string';
          } else if (/true|false/.test(match)) {
            cls = 'j-bool';
          } else if (/null/.test(match)) {
            cls = 'j-null';
          }
          return '<span class="' + cls + '">' + match + '</span>';
        });
    }

    function buildEventCard(ev, isNew = false) {
      const parsedLabel = tryParseJSONMaybeString(ev.eventLabel);
      const displayObj = {
        eventName: ev.eventName ?? null,
        screenName: ev.screenName ?? null,
        eventAction: ev.eventAction ?? null,
        eventTimestamp: ev.eventTimestamp ?? null,
        eventLabel: parsedLabel,
        _received_at: ev._received_at ?? null,
        _source_endpoint: ev._source_endpoint ?? null,
      };
      const wrap = document.createElement('div');
      wrap.className = 'event-card' + (isNew ? ' flash-new' : '');
      const head = document.createElement('div');
      head.className = 'event-head';
      const title = document.createElement('div');
      title.textContent = ev.eventName || '(no eventName)';
      const right = document.createElement('div');
      right.className = 'head-right';
      const badge = document.createElement('span');
      badge.className = 'badge';
      badge.textContent = ev.eventTimestamp || '';
      right.appendChild(badge);
      if (isNew) { const dot = document.createElement('span'); dot.className='badge dot dot-new'; right.appendChild(dot); }
      head.appendChild(title);
      head.appendChild(right);
      const pre = document.createElement('pre');
      pre.innerHTML = syntaxHighlight(displayObj);
      wrap.appendChild(head);
      wrap.appendChild(pre);
      return wrap;
    }

    // Core incremental processing and per-pane dedup
    const globalSeen = new Set();
    const paneSeen = panes.map(() => new Set());
    let seq = 0;
    function eventId(ev) {
      const label = typeof ev.eventLabel === 'string' ? ev.eventLabel : JSON.stringify(ev.eventLabel ?? '');
      return [ev.eventName||'', ev.screenName||'', ev.eventAction||'', ev.eventTimestamp||'', label].join('::');
    }
    function handleEvents(events) {
      // newest first by timestamp if possible
      events.sort((a, b) => (Number(b.eventTimestamp) || 0) - (Number(a.eventTimestamp) || 0));
      for (const ev of events) {
        const id = eventId(ev);
        if (!('_seq' in ev)) ev._seq = seq++;
        // Track globally so tabs can share if needed later
        if (!globalSeen.has(id)) globalSeen.add(id);
        panes.forEach((pane, idx) => {
          if (!pane.name) return;
          if ((ev.eventName || '').toLowerCase() !== pane.name.toLowerCase()) return;
          const seenSet = paneSeen[idx];
          if (seenSet.has(id)) return; // dedupe within pane across refreshes
          seenSet.add(id);
          pane.count++;
          pane.countEl.textContent = String(pane.count);
          // Ensure only newest batch shows the dot
          pane.stream.querySelectorAll('.dot-new').forEach(el => el.remove());
          pane.stream.prepend(buildEventCard(ev, true));
          while (pane.stream.children.length > 50) pane.stream.removeChild(pane.stream.lastChild);
        });
      }
    }

    async function fetchAndUpdate() {
      try {
        statusEl.textContent = 'Fetching...';
        const res = await fetch(FETCH_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const events = Array.isArray(data) ? data : Array.isArray(data.events) ? data.events : [];
        handleEvents(events);
        statusEl.textContent = 'Live';
      } catch (err) {
        statusEl.textContent = `Error: ${String(err)}`;
        console.error(err);
      }
    }

    panes.forEach((p, idx) => {
      p.input.addEventListener('input', () => {
        p.name = p.input.value.trim();
        p.count = 0;
        p.countEl.textContent = '0';
        p.stream.innerHTML = '';
        paneSeen[idx].clear();
      });
    });

    // Global refresh interval persistence
    function loadInterval(){
      const saved = Number(localStorage.getItem('refreshIntervalMs') || '3000');
      if (!Number.isNaN(saved)) {
        if (!Array.from(intervalSel.options).some(o => Number(o.value) === saved)) {
          const opt = document.createElement('option'); opt.value=String(saved); opt.textContent = (saved===0? 'Pause' : `${saved/1000}s`); intervalSel.appendChild(opt);
        }
        intervalSel.value = String(saved);
      }
    }
    function saveInterval(ms){ localStorage.setItem('refreshIntervalMs', String(ms)); }
    let timer = null;
    function startPolling(intervalMs) { stopPolling(); if (intervalMs === 0) { statusEl.textContent = 'Paused'; return; } fetchAndUpdate(); timer = setInterval(fetchAndUpdate, intervalMs); statusEl.textContent = `Polling every ${intervalMs/1000}s`; }
    function stopPolling() { if (timer) clearInterval(timer); timer = null; }

    intervalSel.addEventListener('change', () => { const ms = Number(intervalSel.value); saveInterval(ms); startPolling(ms); });
    loadInterval();
    startPolling(Number(intervalSel.value));
    window.addEventListener('storage', (e)=>{ if(e.key==='refreshIntervalMs'){ const v = Number(e.newValue||'3000'); intervalSel.value = String(v); startPolling(v); }});
    window.addEventListener('global-logs-cleared', ()=> { panes.forEach((p, idx)=>{ p.stream.innerHTML=''; p.count=0; p.countEl.textContent='0'; paneSeen[idx].clear(); }); statusEl.textContent='Cleared'; });
  </script>
</body>
</html>

