<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Events</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #121826;
      --border: #1e293b;
      --key: #7dd3fc;
      --string: #a7f3d0;
      --number: #fca5a5;
      --bool: #fde68a;
      --null: #c4b5fd;
      --title: #e2e8f0;
      --text: #cbd5e1;
      --muted: #94a3b8;
      --badge: #334155;
      --accent: #3b82f6;
    }
    body.light {
      --bg: #f5f6f8;
      --card: #ffffff;
      --border: #dce1e7;
      --key: #0369a1;
      --string: #047857;
      --number: #b91c1c;
      --bool: #a16207;
      --null: #6d28d9;
      --title: #0f172a;
      --text: #0f172a;
      --muted: #475569;
      --badge: #e5e7eb;
      --accent: #2563eb;
    }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    header { position: sticky; top: 0; background: color-mix(in oklab, var(--bg) 90%, transparent); padding: 12px 16px; border-bottom: 1px solid var(--border); backdrop-filter: blur(12px); z-index: 10; }
    header .row { display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .status { font-size: 12px; color: var(--muted); }
    .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .left { display: flex; gap: 10px; align-items: center; }
    .nav { display: flex; gap: 8px; }
    .btn, select, input[type="text"] { background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 6px 10px; font-size: 13px; line-height: 1.2; box-shadow: 0 1px 0 rgba(0,0,0,0.05); }
    .btn { cursor: pointer; }
    .btn.primary { background: linear-gradient(to bottom, color-mix(in oklab, var(--accent) 85%, white), var(--accent)); color: white; border: 1px solid color-mix(in oklab, var(--accent) 60%, black); }
    .btn.ghost { background: transparent; }
    main { padding: 16px; display: grid; gap: 12px; }
    .event-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 12px; }
    .event-header { display: flex; align-items: baseline; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
    .event-title { font-weight: 700; color: var(--title); font-size: 14px; }
    .badges { display: flex; gap: 6px; flex-wrap: wrap; }
    .badge { font-size: 11px; padding: 2px 6px; border-radius: 999px; background: var(--badge); color: var(--text); border: 1px solid var(--border); }
    pre { margin: 0; white-space: pre-wrap; word-wrap: break-word; background: color-mix(in oklab, var(--card) 90%, black); border-radius: 8px; padding: 10px; border: 1px solid var(--border); overflow: auto; font-size: 12px; line-height: 1.5; }
    .j-key { color: var(--key); }
    .j-string { color: var(--string); }
    .j-number { color: var(--number); }
    .j-bool { color: var(--bool); }
    .j-null { color: var(--null); }
    @keyframes flashNew { from { box-shadow: 0 0 0 9999px rgba(34,197,94,0.14) inset; } to { box-shadow: 0 0 0 9999px rgba(34,197,94,0) inset; } }
    .flash-new { animation: flashNew 1100ms ease-out 1; }
  </style>
</head>
<body>
  {% include "_navbar.html" %}
  <header style="display:none"></header>
  <section style="padding:12px 16px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
    <div id="status" class="status">Idle</div>
    <label for="interval">Refresh</label>
    <select id="interval">
      <option value="1000" selected>1s</option>
      <option value="2000">2s</option>
      <option value="5000">5s</option>
      <option value="10000">10s</option>
      <option value="0">Pause</option>
    </select>
    <button id="clear" class="btn">Clear</button>
  </section>

  <main id="events"></main>

  <script>
    const FETCH_URL = '/events-feed';

    const container = document.getElementById('events');
    const statusEl = document.getElementById('status');
    const intervalSel = document.getElementById('interval');
    const clearBtn = document.getElementById('clear');
    // Hook global search from navbar
    const filterName = document.getElementById('globalSearch');

    const seen = new Set();
    const allEvents = [];
    let currentFilter = '';
    let seq = 0; // sequence to preserve arrival order when timestamps are missing

    function eventId(ev) {
      const label = typeof ev.eventLabel === 'string' ? ev.eventLabel : JSON.stringify(ev.eventLabel ?? '');
      return [
        ev.eventName ?? '',
        ev.screenName ?? '',
        ev.eventAction ?? '',
        ev.eventTimestamp ?? '',
        label
      ].join('::');
    }

    function tryParseJSONMaybeString(str) {
      if (typeof str !== 'string') return str;
      try { return JSON.parse(str); } catch (_) { return str; }
    }

    function syntaxHighlight(obj) {
      const json = JSON.stringify(obj, null, 2);
      return json
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/("(\\u[a-fA-F0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d+)?(?:[eE][+\-]?\d+)?)/g, match => {
          let cls = 'j-number';
          if (/^"/.test(match)) {
            cls = /:$/.test(match) ? 'j-key' : 'j-string';
          } else if (/true|false/.test(match)) {
            cls = 'j-bool';
          } else if (/null/.test(match)) {
            cls = 'j-null';
          }
          return '<span class="' + cls + '">' + match + '</span>';
        });
    }

    function buildEventCard(ev, isNew = false) {
      const parsedLabel = tryParseJSONMaybeString(ev.eventLabel);
      const displayObj = {
        eventName: ev.eventName ?? null,
        screenName: ev.screenName ?? null,
        eventAction: ev.eventAction ?? null,
        eventTimestamp: ev.eventTimestamp ?? null,
        eventLabel: parsedLabel,
        _received_at: ev._received_at ?? null,
        _source_endpoint: ev._source_endpoint ?? null,
      };

      const card = document.createElement('section');
      card.className = 'event-card' + (isNew ? ' flash-new' : '');

      const header = document.createElement('div');
      header.className = 'event-header';

      const title = document.createElement('div');
      title.className = 'event-title';
      title.textContent = ev.eventName || '(no eventName)';

      const badges = document.createElement('div');
      badges.className = 'badges';
      for (const [k, v] of Object.entries({ screen: ev.screenName, action: ev.eventAction, ts: ev.eventTimestamp })) {
        if (!v) continue;
        const b = document.createElement('span');
        b.className = 'badge';
        b.textContent = `${k}: ${v}`;
        badges.appendChild(b);
      }

      header.appendChild(title);
      header.appendChild(badges);

      const pre = document.createElement('pre');
      pre.innerHTML = syntaxHighlight(displayObj);

      card.appendChild(header);
      card.appendChild(pre);
      return card;
    }

    function eventSortKey(ev) {
      const ts = Number(ev.eventTimestamp);
      if (!Number.isNaN(ts) && ts > 0) return ts;
      return ev._seq ?? -Infinity;
    }

    function renderList() {
      container.innerHTML = '';
      const q = currentFilter.trim().toLowerCase();
      const base = q ? allEvents.filter(e => (e.eventName || '').toLowerCase().includes(q)) : allEvents.slice();
      base.sort((a, b) => eventSortKey(b) - eventSortKey(a)); // newest first
      const frag = document.createDocumentFragment();
      for (const ev of base) {
        frag.appendChild(buildEventCard(ev));
      }
      container.appendChild(frag);
      statusEl.textContent = `Showing ${base.length} event(s)`;
    }

    function appendNewEvents(events) {
      const q = currentFilter.trim().toLowerCase();
      const newOnes = [];
      for (const ev of events) {
        const id = eventId(ev);
        if (seen.has(id)) continue;
        seen.add(id);
        if (ev._seq == null) ev._seq = seq++;
        allEvents.push(ev);
        // if it matches current filter (or no filter), queue for prepend
        if (!q || (ev.eventName || '').toLowerCase().includes(q)) newOnes.push(ev);
      }
      if (newOnes.length > 0) {
        newOnes.sort((a,b)=> eventSortKey(b)-eventSortKey(a));
        for (const ev of newOnes) { container.prepend(buildEventCard(ev, true)); }
        statusEl.textContent = `Added ${newOnes.length} new event(s) • ${new Date().toLocaleTimeString()}`;
      } else {
        statusEl.textContent = `No new events • ${new Date().toLocaleTimeString()}`;
      }
    }

    async function fetchAndUpdate() {
      try {
        statusEl.textContent = 'Fetching...';
        const res = await fetch(FETCH_URL, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const events = Array.isArray(data) ? data : Array.isArray(data.events) ? data.events : [];
        appendNewEvents(events);
      } catch (err) {
        statusEl.textContent = `Error: ${String(err)}`;
        console.error(err);
      }
    }

    let timer = null;
    function startPolling(intervalMs) {
      stopPolling();
      if (intervalMs === 0) { statusEl.textContent = 'Paused'; return; }
      fetchAndUpdate();
      timer = setInterval(fetchAndUpdate, intervalMs);
      statusEl.textContent = `Polling every ${intervalMs/1000}s`;
    }
    function stopPolling() { if (timer) clearInterval(timer); timer = null; }

    intervalSel.addEventListener('change', () => { startPolling(Number(intervalSel.value)); });
    clearBtn.addEventListener('click', () => { container.innerHTML = ''; seen.clear(); allEvents.length = 0; statusEl.textContent = 'Cleared'; });
    // Wire global search both via input and custom event
    function setFilter(val){ currentFilter = val; renderList(); }
    window.applyGlobalSearch = setFilter;
    window.readGlobalSearch = () => currentFilter;
    if (filterName) filterName.addEventListener('input', () => setFilter(filterName.value));
    window.addEventListener('global-search-change', (e) => setFilter(e.detail || ''));

    startPolling(Number(intervalSel.value));
  </script>
</body>
</html>

