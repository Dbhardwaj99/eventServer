<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Event Server</title>
    <style>
      :root {
        --bg: #0e1117;
        --card: #111827;
        --card-alt: #0f1623;
        --border: #1f2937;
        --title: #e5e7eb;
        --text: #d1d5db;
        --muted: #9ca3af;
        --badge: #1f2937;
        --accent: #22c55e;
        --dot: #22c55e;
        --shadow: rgba(0,0,0,0.3);
        --key: #7dd3fc; --string: #a7f3d0; --number: #fca5a5; --bool: #fde68a; --null: #c4b5fd;
      }
      body.light {
        --bg: #f7f7f5;
        --card: #ffffff;
        --card-alt: #f8fafc;
        --border: #e5e7eb;
        --title: #0f172a;
        --text: #1f2937;
        --muted: #6b7280;
        --badge: #eef2f7;
        --accent: #16a34a;
        --dot: #16a34a;
        --shadow: rgba(0,0,0,0.06);
        --key: #0369a1; --string: #047857; --number: #b91c1c; --bool: #a16207; --null: #6d28d9;
      }
      body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
      header { position: sticky; top: 0; background: color-mix(in oklab, var(--bg) 92%, transparent); padding: 12px 16px; border-bottom: 1px solid var(--border); backdrop-filter: blur(10px); z-index: 10; }
      header .row { display: flex; gap: 12px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
      .status { font-size: 12px; color: var(--muted); }
      .controls { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
      .left { display: flex; gap: 10px; align-items: center; }
      .nav { display: flex; gap: 8px; }
      .btn, select { background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 10px; padding: 6px 10px; font-size: 13px; line-height: 1.2; box-shadow: 0 1px 0 var(--shadow); }
      .btn { cursor: pointer; }
      .btn.primary { background: linear-gradient(to bottom, color-mix(in oklab, var(--accent) 85%, white), var(--accent)); color: white; border: 1px solid color-mix(in oklab, var(--accent) 60%, black); }
      main { padding: 16px; display: grid; gap: 12px; }
      .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 14px; box-shadow: 0 2px 0 var(--shadow); }
      .row2 { display: flex; align-items: baseline; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
      .title { font-weight: 700; color: var(--title); font-size: 15px; letter-spacing: 0.2px; }
      .badges { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
      .badge { font-size: 11px; padding: 2px 8px; border-radius: 999px; background: var(--badge); color: var(--text); border: 1px solid var(--border); }
      .badge.dot { width: 8px; height: 8px; padding: 0; border-radius: 999px; background: var(--dot); border: 1px solid color-mix(in oklab, var(--dot) 40%, black); box-shadow: 0 0 0 3px color-mix(in oklab, var(--dot) 20%, transparent); }
      pre { margin: 0; white-space: pre-wrap; word-wrap: break-word; background: var(--card-alt); border-radius: 10px; padding: 12px; border: 1px solid var(--border); overflow: auto; font-size: 12px; line-height: 1.55; }
      .j-key { color: var(--key); }
      .j-string { color: var(--string); }
      .j-number { color: var(--number); }
      .j-bool { color: var(--bool); }
      .j-null { color: var(--null); }
      .empty { text-align: center; color: var(--muted); padding: 48px 0; }
      @keyframes flashNew { from { box-shadow: 0 0 0 9999px rgba(34,197,94,0.12) inset; } to { box-shadow: 0 0 0 9999px rgba(34,197,94,0) inset; } }
      .flash-new { animation: flashNew 900ms ease-out 1; }
    </style>
    <script>
      window.addEventListener('DOMContentLoaded', () => {
        // Syntax highlight JSON in code blocks
        function syntaxHighlight(txt) {
          const esc = txt.replace(/&/g,'&amp;').replace(/</g,'&lt;');
          return esc.replace(/("(\\u[a-fA-F0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d+)?(?:[eE][+\-]?\d+)?)/g, m => {
            let cls = 'j-number';
            if (/^"/.test(m)) cls = /:$/.test(m) ? 'j-key' : 'j-string';
            else if (/true|false/.test(m)) cls = 'j-bool';
            else if (/null/.test(m)) cls = 'j-null';
            return '<span class="'+cls+'">'+m+'</span>';
          });
        }
        document.querySelectorAll('pre[data-json] code').forEach(code => {
          code.innerHTML = syntaxHighlight(code.textContent);
        });
      });
    </script>
  </head>
  <body>
    {% include "_navbar.html" %}
    <header style="display:none"></header>

    <section style="padding:12px 16px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <div id="status" class="status">Idle</div>
      <label for="interval">Refresh</label>
      <select id="interval">
        <option value="1000">1s</option>
        <option value="2000">2s</option>
        <option value="3000" selected>3s</option>
        <option value="5000">5s</option>
        <option value="10000">10s</option>
        <option value="0">Pause</option>
      </select>
      <form method="post" action="/clear" onsubmit="return confirm('Clear all logs?');">
        <button type="submit" class="btn">Clear</button>
      </form>
    </section>

    <main id="logs"></main>

    <script>
      const statusEl = document.getElementById('status');
      const intervalSel = document.getElementById('interval');
      const container = document.getElementById('logs');
      const seen = new Set();
      const allLogs = [];
      let seq = 0;

      function logId(item) {
        return [item.timestamp||'', item.endpoint||'', item.method||''].join('::') + '::' + JSON.stringify(item.json||'');
      }
      function syntaxHighlight(txt) {
        const esc = txt.replace(/\&/g,'&amp;').replace(/</g,'&lt;');
        return esc.replace(/("(\\u[a-fA-F0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d+)?(?:[eE][+\-]?\d+)?)/g, m => {
          let cls = 'j-number';
          if (/^"/.test(m)) cls = /:$/.test(m) ? 'j-key' : 'j-string';
          else if (/true|false/.test(m)) cls = 'j-bool';
          else if (/null/.test(m)) cls = 'j-null';
          return '<span class="'+cls+'">'+m+'</span>';
        });
      }
      function buildLogCard(item, isNew=false) {
        const sec = document.createElement('section');
        sec.className = 'card'+(isNew?' flash-new':'');
        const head = document.createElement('div'); head.className = 'row2';
        const title = document.createElement('div'); title.className = 'title'; title.textContent = item.endpoint || '';
        const badges = document.createElement('div'); badges.className='badges';
        const b1 = document.createElement('span'); b1.className='badge'; b1.textContent = (item.timestamp||'') + ' IST'; badges.appendChild(b1);
        const b2 = document.createElement('span'); b2.className='badge'; b2.textContent = item.method||''; badges.appendChild(b2);
        if (isNew) { const dot = document.createElement('span'); dot.className = 'badge dot dot-new'; badges.appendChild(dot); }
        head.appendChild(title); head.appendChild(badges);
        const pre = document.createElement('pre'); const code = document.createElement('code');
        code.innerHTML = syntaxHighlight(JSON.stringify(item.json ?? null, null, 2)); pre.appendChild(code);
        sec.appendChild(head); sec.appendChild(pre);
        return sec;
      }
      function sortKey(item) { return item._seq ?? 0; }
      function renderAll() {
        container.innerHTML = '';
        const frag = document.createDocumentFragment();
        const base = allLogs.slice().sort((a,b)=> sortKey(b)-sortKey(a));
        for (const it of base) frag.appendChild(buildLogCard(it));
        container.appendChild(frag);
      }
      async function fetchAndUpdate(){
        try {
          statusEl.textContent = 'Fetching...';
          const res = await fetch('/logs-feed', { cache: 'no-store' });
          if (!res.ok) throw new Error('HTTP '+res.status);
          const data = await res.json();
          const items = Array.isArray(data.items) ? data.items : [];
          let added = 0;
          const newOnes = [];
          for (const it of items) {
            const id = logId(it);
            if (seen.has(id)) continue;
            seen.add(id);
            it._seq = seq++;
            allLogs.push(it);
            newOnes.push(it);
            added++;
          }
          if (added>0) {
            // remove old new markers so only latest batch has dots
            document.querySelectorAll('.dot-new').forEach(el => el.remove());
            // Prepend only new ones (newest first)
            newOnes.sort((a,b)=> sortKey(b)-sortKey(a));
            for (const it of newOnes) {
              container.prepend(buildLogCard(it, true));
            }
          }
          if (container.children.length === 0 && allLogs.length === 0) {
            container.innerHTML = '<div class="empty">No requests yet. Send a POST request to any endpoint.</div>';
          }
          statusEl.textContent = added>0 ? `Added ${added} • ${new Date().toLocaleTimeString()}` : `No new • ${new Date().toLocaleTimeString()}`;
        } catch (e) {
          statusEl.textContent = 'Error: '+String(e);
          console.error(e);
        }
      }
      // Global refresh interval persistence
      function loadInterval(){
        const saved = Number(localStorage.getItem('refreshIntervalMs') || '3000');
        if (!Number.isNaN(saved)) {
          if (!Array.from(intervalSel.options).some(o => Number(o.value) === saved)) {
            const opt = document.createElement('option'); opt.value=String(saved); opt.textContent = (saved===0? 'Pause' : `${saved/1000}s`); intervalSel.appendChild(opt);
          }
          intervalSel.value = String(saved);
        }
      }
      function saveInterval(ms){ localStorage.setItem('refreshIntervalMs', String(ms)); }
      let timer=null;
      function startPolling(ms){ stopPolling(); if(ms===0){ statusEl.textContent='Paused'; return;} fetchAndUpdate(); timer=setInterval(fetchAndUpdate, ms); }
      function stopPolling(){ if(timer) clearInterval(timer); timer=null; }
      intervalSel.addEventListener('change', ()=> { const ms = Number(intervalSel.value); saveInterval(ms); startPolling(ms); });
      loadInterval();
      startPolling(Number(intervalSel.value));
      window.addEventListener('storage', (e)=>{ if(e.key==='refreshIntervalMs'){ const v = Number(e.newValue||'3000'); intervalSel.value = String(v); startPolling(v); }});
      window.addEventListener('global-logs-cleared', ()=> { container.innerHTML=''; seen.clear(); allLogs.length=0; seq=0; statusEl.textContent='Cleared'; });
    </script>
  </body>
</html>
